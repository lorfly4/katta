<div class="container mt-4">
  <div class="row mb-2">
    <div class="col-sm-6">
      <h1 class="m-0">Tambah Produk</h1>
    </div>
    <div class="col-sm-6">
      <ol class="breadcrumb float-sm-right" style="background-color: #f4f6f9">
        <li class="breadcrumb-item"><a href="#">Home</a></li>
        <li class="breadcrumb-item active">Tambah Produk</li>
      </ol>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">Input Data Produk</div>
        <div class="card-body">
          <form
            action="/produk/create"
            method="POST"
            enctype="multipart/form-data"
          >
            <div class="form-group">
              <label for="kategori">Kategori</label>
              <div style="display: flex; gap: 8px">
                <select
                  class="form-control"
                  id="kategori"
                  name="kategori"
                  required
                  style="flex: 1"
                >
                  <% if (kategori.length === 0) { %>
                  <option value="">-- Belum ada kategori --</option>
                  <% } else { %> <% kategori.forEach(function(kat) { %>
                  <option value="<%= kat.id %>">
                    <%= kat.nama_kategori %>
                  </option>
                  <% }); %> <% } %>
                </select>
                <button
                  type="button"
                  class="btn btn-success"
                  onclick="showAddKategoriModal()"
                >
                  Tambah
                </button>
              </div>
            </div>

            <!-- Modal tambah kategori -->
            <div
              id="modal-add-kategori"
              style="
                display: none;
                position: fixed;
                left: 0;
                top: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.3);
                z-index: 9999;
                align-items: center;
                justify-content: center;
              "
            >
              <div
                style="
                  background: #fff;
                  padding: 24px;
                  border-radius: 8px;
                  min-width: 300px;
                "
              >
                <h5>Tambah Kategori</h5>
                <input
                  type="text"
                  id="input-nama-kategori"
                  class="form-control"
                  placeholder="Nama kategori baru"
                />
                <div style="margin-top: 12px; text-align: right">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick="closeAddKategoriModal()"
                  >
                    Batal
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="addKategori()"
                  >
                    Simpan
                  </button>
                </div>
              </div>
            </div>

            <script>
              function showAddKategoriModal() {
                document.getElementById("modal-add-kategori").style.display =
                  "flex";
                document.getElementById("input-nama-kategori").value = "";
              }
              function closeAddKategoriModal() {
                document.getElementById("modal-add-kategori").style.display =
                  "none";
              }
              function addKategori() {
                const nama = document
                  .getElementById("input-nama-kategori")
                  .value.trim();
                if (!nama) {
                  alert("Nama kategori harus diisi!");
                  return;
                }
                // Kirim ke backend via AJAX
                fetch("/kategori/create", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ nama_kategori: nama }),
                })
                  .then((res) => res.json())
                  .then((data) => {
                    if (data.id) {
                      // Tambahkan ke select
                      const select = document.getElementById("kategori");
                      const option = document.createElement("option");
                      option.value = data.id;
                      option.textContent = data.nama_kategori;
                      option.selected = true;
                      select.appendChild(option);
                      closeAddKategoriModal();
                    } else {
                      alert(data.error || "Gagal menambah kategori");
                    }
                  })
                  .catch(() => alert("Gagal menambah kategori"));
              }
            </script>
            <div class="form-group">
              <a
                id="show-hide-gambar"
                style="display: inline-block; cursor: pointer; color: #007bff"
                onclick="showHideGambar()"
                >Tampilkan input foto produk</a
              >
              <div
                id="gambar-wrapper"
                style="overflow: hidden; transition: max-height 0.5s ease"
              >
                <input
                  type="file"
                  id="gambar"
                  name="gambar"
                  style="width: 100%"
                  accept="image/*"
                  onchange="previewGambar(event)"
                />
                <img
                  id="preview-img"
                  src="#"
                  alt="Preview"
                  style="
                    display: none;
                    max-width: 150px;
                    margin-top: 10px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                  "
                />
              </div>
              <style>
                #gambar-wrapper {
                  max-height: 0;
                  transition: max-height 0.5s ease;
                }
                #gambar-wrapper input[type="file"] {
                  opacity: 0;
                  pointer-events: none;
                  transition: opacity 0.5s;
                }
                #gambar-wrapper.show {
                  max-height: 120px;
                }
                #gambar-wrapper.show input[type="file"] {
                  opacity: 1;
                  pointer-events: auto;
                }
                #gambar-wrapper.show #preview-img {
                  display: block;
                }
              </style>
              <script>
                function showHideGambar() {
                  var wrapper = document.getElementById("gambar-wrapper");
                  var link = document.getElementById("show-hide-gambar");
                  if (wrapper.classList.contains("show")) {
                    wrapper.classList.remove("show");
                    link.textContent = "Tampilkan input foto produk";
                  } else {
                    wrapper.classList.add("show");
                    link.textContent = "Sembunyikan foto produk";
                  }
                }

                function previewGambar(event) {
                  var input = event.target;
                  var preview = document.getElementById("preview-img");
                  if (input.files && input.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                      preview.src = e.target.result;
                      preview.style.display = "block";
                    };
                    reader.readAsDataURL(input.files[0]);
                  } else {
                    preview.src = "#";
                    preview.style.display = "none";
                  }
                }
              </script>
            </div>
            <div class="form-group">
              <label for="nama-produk">Nama Produk</label>
              <input
                type="text"
                class="form-control"
                id="nama-produk"
                name="nama_produk"
                placeholder="Masukkan Nama Produk"
                required
              />
            </div>
            <div class="form-group">
              <label for="satuan">Satuan</label>
              <input
                type="text"
                class="form-control"
                id="satuan"
                name="satuan"
                placeholder="Masukkan Satuan"
                required
              />
            </div>
            <div class="form-group">
              <label for="kode-sku">Kode/SKU</label>
              <input
                type="text"
                class="form-control"
                id="kode-sku"
                name="kode_sku"
                placeholder="Masukkan Kode/SKU"
                required
              />
            </div>
            <div class="form-group">
              <label for="deskripsi">Deskripsi</label>
              <textarea
                class="form-control"
                id="deskripsi"
                name="deskripsi"
                rows="3"
                placeholder="Masukkan Deskripsi"
                required
              ></textarea>
            </div>
            <div class="form-group">
              <label for="harga-jual">Harga Jual</label>
              <input
                type="number"
                class="form-control"
                id="harga-jual"
                name="harga_jual"
                placeholder="Masukkan Harga Jual"
                required
              />
            </div>
            <div class="form-group">
              <label for="harga-beli">Harga Beli</label>
              <input
                type="number"
                class="form-control"
                id="harga-beli"
                name="harga_beli"
                placeholder="Masukkan Harga Beli"
                required
              />
            </div>
            <button
              type="submit"
              class="btn btn-primary"
              onclick="return validateForm(event)"
            >
              Simpan
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function validateForm(event) {
    const namaProduk = document.getElementById("nama-produk").value.trim();
    if (namaProduk !== "") {
      Swal.fire("Saved!", "Your data has been saved.", "success");
      // Form will submit after alert closes
      return true;
    } else {
      Swal.fire("Error!", "Please enter a valid product name.", "error");
      event.preventDefault();
      return false;
    }
  }
</script>
